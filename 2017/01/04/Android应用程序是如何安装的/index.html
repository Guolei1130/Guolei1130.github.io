<!doctype html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="framework," />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta name="description" content="1.前言当我们安装应用程序的时候，会弹出安装界面，那么，在我们点击安装之后，发生了什么呢？今天就来了解下，应用程序是如何安装的。首先，我们今天介绍的是通过安装器安装应用，当然，在pms的构造函数中，也会将我们原先安装好的应用装载到内存中。">
<meta property="og:type" content="article">
<meta property="og:title" content="Android应用程序是如何安装的">
<meta property="og:url" content="http://guolei1130.github.io/2017/01/04/Android应用程序是如何安装的/index.html">
<meta property="og:site_name" content="_StriveG Blog">
<meta property="og:description" content="1.前言当我们安装应用程序的时候，会弹出安装界面，那么，在我们点击安装之后，发生了什么呢？今天就来了解下，应用程序是如何安装的。首先，我们今天介绍的是通过安装器安装应用，当然，在pms的构造函数中，也会将我们原先安装好的应用装载到内存中。">
<meta property="og:updated_time" content="2017-08-21T15:11:46.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Android应用程序是如何安装的">
<meta name="twitter:description" content="1.前言当我们安装应用程序的时候，会弹出安装界面，那么，在我们点击安装之后，发生了什么呢？今天就来了解下，应用程序是如何安装的。首先，我们今天介绍的是通过安装器安装应用，当然，在pms的构造函数中，也会将我们原先安装好的应用装载到内存中。">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"always"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 'undefined',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://guolei1130.github.io/2017/01/04/Android应用程序是如何安装的/"/>





  <title> Android应用程序是如何安装的 | _StriveG Blog </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">_StriveG Blog</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
    
      <p class="site-subtitle">欢迎来到_StriveG Blog</p>
    
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/me" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-commonweal">
          <a href="/404.html" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-heartbeat"></i> <br />
            
            公益404
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://guolei1130.github.io/2017/01/04/Android应用程序是如何安装的/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="_StriveG">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/img/head.png">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="_StriveG Blog">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="_StriveG Blog" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                Android应用程序是如何安装的
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-01-04T20:24:27+08:00">
                2017-01-04
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/01/04/Android应用程序是如何安装的/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/01/04/Android应用程序是如何安装的/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          
            <span class="post-meta-divider">|</span>
            <span class="page-pv"><i class="fa fa-file-o"></i>
            <span class="busuanzi-value" id="busuanzi_value_page_pv" ></span>
            </span>
          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <p><excerpt in="" index="" |="" 首页摘要=""></excerpt></p>
<h3 id="1-前言"><a href="#1-前言" class="headerlink" title="1.前言"></a>1.前言</h3><p>当我们安装应用程序的时候，会弹出安装界面，那么，在我们点击安装之后，发生了什么呢？今天就来了解下，应用程序是如何安装的。首先，我们今天介绍的是通过安装器安装应用，当然，在pms的构造函数中，也会将我们原先安装好的应用装载到内存中。</p>
<a id="more"></a>
<the rest="" of="" contents="" |="" 余下全文="">



<p>以6.0源码为例。安装器在源码目录packages/apps/PackageInstaller中，</p>
<h3 id="2-安装器"><a href="#2-安装器" class="headerlink" title="2.安装器"></a>2.安装器</h3><p>显示安装 取消按钮的那个界面对应着PackageInstallerActivity，而安装按钮对应的是mOk，对应部分代码。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">if (v == mOk) &#123;</div><div class="line">    if (mOkCanInstall || mScrollView == null) &#123;</div><div class="line">        mInstallFlowAnalytics.setInstallButtonClicked();</div><div class="line">        if (mSessionId != -1) &#123;</div><div class="line">            mInstaller.setPermissionsResult(mSessionId, true);</div><div class="line"></div><div class="line">            // We&apos;re only confirming permissions, so we don&apos;t really know how the</div><div class="line">            // story ends; assume success.</div><div class="line">            mInstallFlowAnalytics.setFlowFinishedWithPackageManagerResult(</div><div class="line">                    PackageManager.INSTALL_SUCCEEDED);</div><div class="line">            finish();</div><div class="line">        &#125; else &#123;</div><div class="line">            startInstall();</div><div class="line">        &#125;</div><div class="line">    &#125; else &#123;</div><div class="line">        mScrollView.pageScroll(View.FOCUS_DOWN);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>虽然，我不知懂这里的mSessionId是什么含义，但是 根据代码能看出，安装一个应用应该是startInstall方法。在这个方法中，最终会去玩InstallAppProgress这个界面，对应我们安装中进度条显示的界面。有如下代码。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">if (&quot;package&quot;.equals(mPackageURI.getScheme())) &#123;</div><div class="line">    try &#123;</div><div class="line">        pm.installExistingPackage(mAppInfo.packageName);</div><div class="line">        observer.packageInstalled(mAppInfo.packageName,</div><div class="line">                PackageManager.INSTALL_SUCCEEDED);</div><div class="line">    &#125; catch (PackageManager.NameNotFoundException e) &#123;</div><div class="line">        observer.packageInstalled(mAppInfo.packageName,</div><div class="line">                PackageManager.INSTALL_FAILED_INVALID_APK);</div><div class="line">    &#125;</div><div class="line">&#125; else &#123;</div><div class="line">    pm.installPackageWithVerificationAndEncryption(mPackageURI, observer, installFlags,</div><div class="line">            installerPackageName, verificationParams, null);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>mPackageURI，安装应用的话，应该是file</li>
<li>pm 为ApplicationPackageManager</li>
</ul>
<p>因此，我们看installPackageWithVerificationAndEncryption方法。</p>
<h3 id="3-ApplicationPackageManager-installPackageWithVerificationAndEncryption"><a href="#3-ApplicationPackageManager-installPackageWithVerificationAndEncryption" class="headerlink" title="3.ApplicationPackageManager#installPackageWithVerificationAndEncryption"></a>3.ApplicationPackageManager#installPackageWithVerificationAndEncryption</h3><p>在这个方法中，会调用installCommon方法，而installCommon方法中，会进行简单的参数校验，然后调用mPM的installPackage方法去安装。这个mPM参数实在构造的时候传入的。是通过ActivityThread.getPackageManager()获取。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">public static IPackageManager getPackageManager() &#123;</div><div class="line">    if (sPackageManager != null) &#123;</div><div class="line">        //Slog.v(&quot;PackageManager&quot;, &quot;returning cur default = &quot; + sPackageManager);</div><div class="line">        return sPackageManager;</div><div class="line">    &#125;</div><div class="line">    IBinder b = ServiceManager.getService(&quot;package&quot;);</div><div class="line">    //Slog.v(&quot;PackageManager&quot;, &quot;default service binder = &quot; + b);</div><div class="line">    sPackageManager = IPackageManager.Stub.asInterface(b);</div><div class="line">    //Slog.v(&quot;PackageManager&quot;, &quot;default service = &quot; + sPackageManager);</div><div class="line">    return sPackageManager;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>从中可以看出，其binder服务端为PackageManagerService.</p>
<h3 id="4-PackageManagerService-installPackage"><a href="#4-PackageManagerService-installPackage" class="headerlink" title="4.PackageManagerService#installPackage"></a>4.PackageManagerService#installPackage</h3><p>在这个方法中，回调用installPackageAsUser方法。在这个方法中，会发送一个消息，执行安装过程的第一个阶段，copy</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">final Message msg = mHandler.obtainMessage(INIT_COPY);</div><div class="line">msg.obj = new InstallParams(origin, null, observer, installFlags, installerPackageName,</div><div class="line">        null, verificationParams, user, packageAbiOverride, null);</div><div class="line">mHandler.sendMessage(msg);</div></pre></td></tr></table></figure>
<p>这里的mHandler为PackageHandler实例对象，其消息处理部分代码在doHandleMessage中，我们看INIT_COPY，做了什么？</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">case INIT_COPY: &#123;</div><div class="line">    HandlerParams params = (HandlerParams) msg.obj;</div><div class="line">    int idx = mPendingInstalls.size();</div><div class="line">    if (DEBUG_INSTALL) Slog.i(TAG, &quot;init_copy idx=&quot; + idx + &quot;: &quot; + params);</div><div class="line">    // If a bind was already initiated we dont really</div><div class="line">    // need to do anything. The pending install</div><div class="line">    // will be processed later on.</div><div class="line">    if (!mBound) &#123;</div><div class="line">        // If this is the only one pending we might</div><div class="line">        // have to bind to the service again.</div><div class="line">        if (!connectToService()) &#123;</div><div class="line">            Slog.e(TAG, &quot;Failed to bind to media container service&quot;);</div><div class="line">            params.serviceError();</div><div class="line">            return;</div><div class="line">        &#125; else &#123;</div><div class="line">            // Once we bind to the service, the first</div><div class="line">            // pending request will be processed.</div><div class="line">            mPendingInstalls.add(idx, params);</div><div class="line">        &#125;</div><div class="line">    &#125; else &#123;</div><div class="line">        mPendingInstalls.add(idx, params);</div><div class="line">        // Already bound to the service. Just make</div><div class="line">        // sure we trigger off processing the first request.</div><div class="line">        if (idx == 0) &#123;</div><div class="line">            mHandler.sendEmptyMessage(MCS_BOUND);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    break;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>如果没有绑定，就绑定，如果绑定了，将HandlerParams加入到mPendingInstalls中，并且如果以前为空，则发送MCS_BOUND这个空消息。<br>在接受到MCS_BOUND这个消息之后，会循环处理并且再次发送MCS_BOUND消息，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div></pre></td><td class="code"><pre><div class="line">if (DEBUG_INSTALL) Slog.i(TAG, &quot;mcs_bound&quot;);</div><div class="line">if (msg.obj != null) &#123;</div><div class="line">    mContainerService = (IMediaContainerService) msg.obj;</div><div class="line">&#125;</div><div class="line">if (mContainerService == null) &#123;</div><div class="line">    if (!mBound) &#123;</div><div class="line">        // Something seriously wrong since we are not bound and we are not</div><div class="line">        // waiting for connection. Bail out.</div><div class="line">        Slog.e(TAG, &quot;Cannot bind to media container service&quot;);</div><div class="line">        for (HandlerParams params : mPendingInstalls) &#123;</div><div class="line">            // Indicate service bind error</div><div class="line">            params.serviceError();</div><div class="line">        &#125;</div><div class="line">        mPendingInstalls.clear();</div><div class="line">    &#125; else &#123;</div><div class="line">        Slog.w(TAG, &quot;Waiting to connect to media container service&quot;);</div><div class="line">    &#125;</div><div class="line">&#125; else if (mPendingInstalls.size() &gt; 0) &#123;</div><div class="line">    HandlerParams params = mPendingInstalls.get(0);</div><div class="line">    if (params != null) &#123;</div><div class="line">        if (params.startCopy()) &#123;</div><div class="line">            // We are done...  look for more work or to</div><div class="line">            // go idle.</div><div class="line">            if (DEBUG_SD_INSTALL) Log.i(TAG,</div><div class="line">                    &quot;Checking for more work or unbind...&quot;);</div><div class="line">            // Delete pending install</div><div class="line">            if (mPendingInstalls.size() &gt; 0) &#123;</div><div class="line">                mPendingInstalls.remove(0);</div><div class="line">            &#125;</div><div class="line">            if (mPendingInstalls.size() == 0) &#123;</div><div class="line">                if (mBound) &#123;</div><div class="line">                    if (DEBUG_SD_INSTALL) Log.i(TAG,</div><div class="line">                            &quot;Posting delayed MCS_UNBIND&quot;);</div><div class="line">                    removeMessages(MCS_UNBIND);</div><div class="line">                    Message ubmsg = obtainMessage(MCS_UNBIND);</div><div class="line">                    // Unbind after a little delay, to avoid</div><div class="line">                    // continual thrashing.</div><div class="line">                    sendMessageDelayed(ubmsg, 10000);</div><div class="line">                &#125;</div><div class="line">            &#125; else &#123;</div><div class="line">                // There are more pending requests in queue.</div><div class="line">                // Just post MCS_BOUND message to trigger processing</div><div class="line">                // of next pending install.</div><div class="line">                if (DEBUG_SD_INSTALL) Log.i(TAG,</div><div class="line">                        &quot;Posting MCS_BOUND for next work&quot;);</div><div class="line">                mHandler.sendEmptyMessage(MCS_BOUND);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125; else &#123;</div><div class="line">    // Should never happen ideally.</div><div class="line">    Slog.w(TAG, &quot;Empty queue&quot;);</div><div class="line">&#125;</div><div class="line">break;</div></pre></td></tr></table></figure>
<p>从上诉代码中，我们就能知道，通过params.startCopy()去执行copy操作，并且如果还有未安装的，会重复发这个消息，知道所有都安装成功。</p>
<h3 id="5-HandlerParams-startCopy"><a href="#5-HandlerParams-startCopy" class="headerlink" title="5.HandlerParams#startCopy"></a>5.HandlerParams#startCopy</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">final boolean startCopy() &#123;</div><div class="line">    boolean res;</div><div class="line">    try &#123;</div><div class="line">        if (DEBUG_INSTALL) Slog.i(TAG, &quot;startCopy &quot; + mUser + &quot;: &quot; + this);</div><div class="line"></div><div class="line">        if (++mRetries &gt; MAX_RETRIES) &#123;</div><div class="line">            Slog.w(TAG, &quot;Failed to invoke remote methods on default container service. Giving up&quot;);</div><div class="line">            mHandler.sendEmptyMessage(MCS_GIVE_UP);</div><div class="line">            handleServiceError();</div><div class="line">            return false;</div><div class="line">        &#125; else &#123;</div><div class="line">            handleStartCopy();</div><div class="line">            res = true;</div><div class="line">        &#125;</div><div class="line">    &#125; catch (RemoteException e) &#123;</div><div class="line">        if (DEBUG_INSTALL) Slog.i(TAG, &quot;Posting install MCS_RECONNECT&quot;);</div><div class="line">        mHandler.sendEmptyMessage(MCS_RECONNECT);</div><div class="line">        res = false;</div><div class="line">    &#125;</div><div class="line">    handleReturnCode();</div><div class="line">    return res;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这里有重试机制。而handleStartCopy的实现在InstallParams中。</p>
<h3 id="6-InstallParams-handleStartCopy"><a href="#6-InstallParams-handleStartCopy" class="headerlink" title="6.InstallParams#handleStartCopy"></a>6.InstallParams#handleStartCopy</h3><p>这个方法比较长，分段来看。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">final StorageManager storage = StorageManager.from(mContext);</div><div class="line">final long lowThreshold = storage.getStorageLowBytes(</div><div class="line">        Environment.getDataDirectory());</div><div class="line"></div><div class="line">final long sizeBytes = mContainerService.calculateInstalledSize(</div><div class="line">        origin.resolvedPath, isForwardLocked(), packageAbiOverride);</div><div class="line"></div><div class="line">if (mInstaller.freeCache(null, sizeBytes + lowThreshold) &gt;= 0) &#123;</div><div class="line">    pkgLite = mContainerService.getMinimalPackageInfo(origin.resolvedPath,</div><div class="line">            installFlags, packageAbiOverride);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>首先，如果需要的空间不够大，就调用Install的freeCache去释放一部分缓存。</p>
<p>这里的mContainerService对应的binder服务端实现，在DefaultContainerService中。</p>
<p>中间经过复杂的判断处理之后，创建一个InstallArgs对象，如果前面的判断结果是能安装成功的话，进入分支。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div></pre></td><td class="code"><pre><div class="line">if (ret == PackageManager.INSTALL_SUCCEEDED) &#123;</div><div class="line">                 /*</div><div class="line">                 * ADB installs appear as UserHandle.USER_ALL, and can only be performed by</div><div class="line">                 * UserHandle.USER_OWNER, so use the package verifier for UserHandle.USER_OWNER.</div><div class="line">                 */</div><div class="line">                int userIdentifier = getUser().getIdentifier();</div><div class="line">                if (userIdentifier == UserHandle.USER_ALL</div><div class="line">                        &amp;&amp; ((installFlags &amp; PackageManager.INSTALL_FROM_ADB) != 0)) &#123;</div><div class="line">                    userIdentifier = UserHandle.USER_OWNER;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                /*</div><div class="line">                 * Determine if we have any installed package verifiers. If we</div><div class="line">                 * do, then we&apos;ll defer to them to verify the packages.</div><div class="line">                 */</div><div class="line">                final int requiredUid = mRequiredVerifierPackage == null ? -1</div><div class="line">                        : getPackageUid(mRequiredVerifierPackage, userIdentifier);</div><div class="line">                if (!origin.existing &amp;&amp; requiredUid != -1</div><div class="line">                        &amp;&amp; isVerificationEnabled(userIdentifier, installFlags)) &#123;</div><div class="line">                    final Intent verification = new Intent(</div><div class="line">                            Intent.ACTION_PACKAGE_NEEDS_VERIFICATION);</div><div class="line">                    verification.addFlags(Intent.FLAG_RECEIVER_FOREGROUND);</div><div class="line">                    verification.setDataAndType(Uri.fromFile(new File(origin.resolvedPath)),</div><div class="line">                            PACKAGE_MIME_TYPE);</div><div class="line">                    verification.addFlags(Intent.FLAG_GRANT_READ_URI_PERMISSION);</div><div class="line"></div><div class="line">                    final List&lt;ResolveInfo&gt; receivers = queryIntentReceivers(verification,</div><div class="line">                            PACKAGE_MIME_TYPE, PackageManager.GET_DISABLED_COMPONENTS,</div><div class="line">                            0 /* TODO: Which userId? */);</div><div class="line"></div><div class="line">                    if (DEBUG_VERIFY) &#123;</div><div class="line">                        Slog.d(TAG, &quot;Found &quot; + receivers.size() + &quot; verifiers for intent &quot;</div><div class="line">                                + verification.toString() + &quot; with &quot; + pkgLite.verifiers.length</div><div class="line">                                + &quot; optional verifiers&quot;);</div><div class="line">                    &#125;</div><div class="line"></div><div class="line">                    final int verificationId = mPendingVerificationToken++;</div><div class="line"></div><div class="line">                    verification.putExtra(PackageManager.EXTRA_VERIFICATION_ID, verificationId);</div><div class="line"></div><div class="line">                    verification.putExtra(PackageManager.EXTRA_VERIFICATION_INSTALLER_PACKAGE,</div><div class="line">                            installerPackageName);</div><div class="line"></div><div class="line">                    verification.putExtra(PackageManager.EXTRA_VERIFICATION_INSTALL_FLAGS,</div><div class="line">                            installFlags);</div><div class="line"></div><div class="line">                    verification.putExtra(PackageManager.EXTRA_VERIFICATION_PACKAGE_NAME,</div><div class="line">                            pkgLite.packageName);</div><div class="line"></div><div class="line">                    verification.putExtra(PackageManager.EXTRA_VERIFICATION_VERSION_CODE,</div><div class="line">                            pkgLite.versionCode);</div><div class="line"></div><div class="line">                    if (verificationParams != null) &#123;</div><div class="line">                        if (verificationParams.getVerificationURI() != null) &#123;</div><div class="line">                           verification.putExtra(PackageManager.EXTRA_VERIFICATION_URI,</div><div class="line">                                 verificationParams.getVerificationURI());</div><div class="line">                        &#125;</div><div class="line">                        if (verificationParams.getOriginatingURI() != null) &#123;</div><div class="line">                            verification.putExtra(Intent.EXTRA_ORIGINATING_URI,</div><div class="line">                                  verificationParams.getOriginatingURI());</div><div class="line">                        &#125;</div><div class="line">                        if (verificationParams.getReferrer() != null) &#123;</div><div class="line">                            verification.putExtra(Intent.EXTRA_REFERRER,</div><div class="line">                                  verificationParams.getReferrer());</div><div class="line">                        &#125;</div><div class="line">                        if (verificationParams.getOriginatingUid() &gt;= 0) &#123;</div><div class="line">                            verification.putExtra(Intent.EXTRA_ORIGINATING_UID,</div><div class="line">                                  verificationParams.getOriginatingUid());</div><div class="line">                        &#125;</div><div class="line">                        if (verificationParams.getInstallerUid() &gt;= 0) &#123;</div><div class="line">                            verification.putExtra(PackageManager.EXTRA_VERIFICATION_INSTALLER_UID,</div><div class="line">                                  verificationParams.getInstallerUid());</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line"></div><div class="line">                    final PackageVerificationState verificationState = new PackageVerificationState(</div><div class="line">                            requiredUid, args);</div><div class="line"></div><div class="line">                    mPendingVerification.append(verificationId, verificationState);</div><div class="line"></div><div class="line">                    final List&lt;ComponentName&gt; sufficientVerifiers = matchVerifiers(pkgLite,</div><div class="line">                            receivers, verificationState);</div><div class="line"></div><div class="line">                    // Apps installed for &quot;all&quot; users use the device owner to verify the app</div><div class="line">                    UserHandle verifierUser = getUser();</div><div class="line">                    if (verifierUser == UserHandle.ALL) &#123;</div><div class="line">                        verifierUser = UserHandle.OWNER;</div><div class="line">                    &#125;</div><div class="line"></div><div class="line">                    /*</div><div class="line">                     * If any sufficient verifiers were listed in the package</div><div class="line">                     * manifest, attempt to ask them.</div><div class="line">                     */</div><div class="line">                    if (sufficientVerifiers != null) &#123;</div><div class="line">                        final int N = sufficientVerifiers.size();</div><div class="line">                        if (N == 0) &#123;</div><div class="line">                            Slog.i(TAG, &quot;Additional verifiers required, but none installed.&quot;);</div><div class="line">                            ret = PackageManager.INSTALL_FAILED_VERIFICATION_FAILURE;</div><div class="line">                        &#125; else &#123;</div><div class="line">                            for (int i = 0; i &lt; N; i++) &#123;</div><div class="line">                                final ComponentName verifierComponent = sufficientVerifiers.get(i);</div><div class="line"></div><div class="line">                                final Intent sufficientIntent = new Intent(verification);</div><div class="line">                                sufficientIntent.setComponent(verifierComponent);</div><div class="line">                                mContext.sendBroadcastAsUser(sufficientIntent, verifierUser);</div><div class="line">                            &#125;</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line"></div><div class="line">                    final ComponentName requiredVerifierComponent = matchComponentForVerifier(</div><div class="line">                            mRequiredVerifierPackage, receivers);</div><div class="line">                    if (ret == PackageManager.INSTALL_SUCCEEDED</div><div class="line">                            &amp;&amp; mRequiredVerifierPackage != null) &#123;</div><div class="line">                        /*</div><div class="line">                         * Send the intent to the required verification agent,</div><div class="line">                         * but only start the verification timeout after the</div><div class="line">                         * target BroadcastReceivers have run.</div><div class="line">                         */</div><div class="line">                        verification.setComponent(requiredVerifierComponent);</div><div class="line">                        mContext.sendOrderedBroadcastAsUser(verification, verifierUser,</div><div class="line">                                android.Manifest.permission.PACKAGE_VERIFICATION_AGENT,</div><div class="line">                                new BroadcastReceiver() &#123;</div><div class="line">                                    @Override</div><div class="line">                                    public void onReceive(Context context, Intent intent) &#123;</div><div class="line">                                        final Message msg = mHandler</div><div class="line">                                                .obtainMessage(CHECK_PENDING_VERIFICATION);</div><div class="line">                                        msg.arg1 = verificationId;</div><div class="line">                                        mHandler.sendMessageDelayed(msg, getVerificationTimeout());</div><div class="line">                                    &#125;</div><div class="line">                                &#125;, null, 0, null, null);</div><div class="line"></div><div class="line">                        /*</div><div class="line">                         * We don&apos;t want the copy to proceed until verification</div><div class="line">                         * succeeds, so null out this field.</div><div class="line">                         */</div><div class="line">                        mArgs = null;</div><div class="line">                    &#125;</div><div class="line">                &#125; else &#123;</div><div class="line">                    /*</div><div class="line">                     * No package verification is enabled, so immediately start</div><div class="line">                     * the remote call to initiate copy using temporary file.</div><div class="line">                     */</div><div class="line">                    ret = args.copyApk(mContainerService, true);</div><div class="line">                &#125;</div><div class="line">            &#125;</div></pre></td></tr></table></figure>
<ul>
<li>如果启动了包验证的话，就会进入验证阶段。 <ul>
<li>发送有序广播， </li>
</ul>
</li>
<li>否则，直接进行复制操作</li>
</ul>
<p>验证部分的逻辑很长，大部分代码都是对intent进行设置。</p>
<h3 id="7-InstallArgs-copyApk"><a href="#7-InstallArgs-copyApk" class="headerlink" title="7.InstallArgs#copyApk"></a>7.InstallArgs#copyApk</h3><p>在createInstallArgs中，会根据InstallParams创建不同的InstallArgs对象。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">private InstallArgs createInstallArgs(InstallParams params) &#123;</div><div class="line">    if (params.move != null) &#123;</div><div class="line">        return new MoveInstallArgs(params);</div><div class="line">    &#125; else if (installOnExternalAsec(params.installFlags) || params.isForwardLocked()) &#123;</div><div class="line">        return new AsecInstallArgs(params);</div><div class="line">    &#125; else &#123;</div><div class="line">        return new FileInstallArgs(params);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>以FileInstallArgs为例，我们来看看。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">int copyApk(IMediaContainerService imcs, boolean temp) throws RemoteException &#123;</div><div class="line">     if (origin.staged) &#123;</div><div class="line">         if (DEBUG_INSTALL) Slog.d(TAG, origin.file + &quot; already staged; skipping copy&quot;);</div><div class="line">         codeFile = origin.file;</div><div class="line">         resourceFile = origin.file;</div><div class="line">         return PackageManager.INSTALL_SUCCEEDED;</div><div class="line">     &#125;</div><div class="line"></div><div class="line">     try &#123;</div><div class="line">         final File tempDir = mInstallerService.allocateStageDirLegacy(volumeUuid);</div><div class="line">         codeFile = tempDir;</div><div class="line">         resourceFile = tempDir;</div><div class="line">     &#125; catch (IOException e) &#123;</div><div class="line">         Slog.w(TAG, &quot;Failed to create copy file: &quot; + e);</div><div class="line">         return PackageManager.INSTALL_FAILED_INSUFFICIENT_STORAGE;</div><div class="line">     &#125;</div><div class="line"></div><div class="line">     final IParcelFileDescriptorFactory target = new IParcelFileDescriptorFactory.Stub() &#123;</div><div class="line">         @Override</div><div class="line">         public ParcelFileDescriptor open(String name, int mode) throws RemoteException &#123;</div><div class="line">             if (!FileUtils.isValidExtFilename(name)) &#123;</div><div class="line">                 throw new IllegalArgumentException(&quot;Invalid filename: &quot; + name);</div><div class="line">             &#125;</div><div class="line">             try &#123;</div><div class="line">                 final File file = new File(codeFile, name);</div><div class="line">                 final FileDescriptor fd = Os.open(file.getAbsolutePath(),</div><div class="line">                         O_RDWR | O_CREAT, 0644);</div><div class="line">                 Os.chmod(file.getAbsolutePath(), 0644);</div><div class="line">                 return new ParcelFileDescriptor(fd);</div><div class="line">             &#125; catch (ErrnoException e) &#123;</div><div class="line">                 throw new RemoteException(&quot;Failed to open: &quot; + e.getMessage());</div><div class="line">             &#125;</div><div class="line">         &#125;</div><div class="line">     &#125;;</div><div class="line"></div><div class="line">     int ret = PackageManager.INSTALL_SUCCEEDED;</div><div class="line">     ret = imcs.copyPackage(origin.file.getAbsolutePath(), target);</div><div class="line">     if (ret != PackageManager.INSTALL_SUCCEEDED) &#123;</div><div class="line">         Slog.e(TAG, &quot;Failed to copy package&quot;);</div><div class="line">         return ret;</div><div class="line">     &#125;</div><div class="line"></div><div class="line">     final File libraryRoot = new File(codeFile, LIB_DIR_NAME);</div><div class="line">     NativeLibraryHelper.Handle handle = null;</div><div class="line">     try &#123;</div><div class="line">         handle = NativeLibraryHelper.Handle.create(codeFile);</div><div class="line">         ret = NativeLibraryHelper.copyNativeBinariesWithOverride(handle, libraryRoot,</div><div class="line">                 abiOverride);</div><div class="line">     &#125; catch (IOException e) &#123;</div><div class="line">         Slog.e(TAG, &quot;Copying native libraries failed&quot;, e);</div><div class="line">         ret = PackageManager.INSTALL_FAILED_INTERNAL_ERROR;</div><div class="line">     &#125; finally &#123;</div><div class="line">         IoUtils.closeQuietly(handle);</div><div class="line">     &#125;</div><div class="line"></div><div class="line">     return ret;</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<ul>
<li>首先mInstallerService.allocateStageDirLegacy申请足够的存储空间</li>
<li>得到申请的那部分空间的文件描述符，并且修改权限</li>
<li>IMediaContainerService#copyPackage 拷贝到指定目录，实现在DefaultContainerService中，</li>
<li>NativeLibraryHelper#copyNativeBinariesWithOverride 拷贝二进制文件(so库)</li>
</ul>
<h3 id="8-DefaultContainerService-copyPackage"><a href="#8-DefaultContainerService-copyPackage" class="headerlink" title="8.DefaultContainerService#copyPackage"></a>8.DefaultContainerService#copyPackage</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">public int copyPackage(String packagePath, IParcelFileDescriptorFactory target) &#123;</div><div class="line">    if (packagePath == null || target == null) &#123;</div><div class="line">        return PackageManager.INSTALL_FAILED_INVALID_URI;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    PackageLite pkg = null;</div><div class="line">    try &#123;</div><div class="line">        final File packageFile = new File(packagePath);</div><div class="line">        pkg = PackageParser.parsePackageLite(packageFile, 0);</div><div class="line">        return copyPackageInner(pkg, target);</div><div class="line">    &#125; catch (PackageParserException | IOException | RemoteException e) &#123;</div><div class="line">        Slog.w(TAG, &quot;Failed to copy package at &quot; + packagePath + &quot;: &quot; + e);</div><div class="line">        return PackageManager.INSTALL_FAILED_INSUFFICIENT_STORAGE;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>解析apk文件</li>
<li>将文件拷贝到指定目录</li>
</ul>
<h3 id="9-NativeLibraryHelper-copyNativeBinariesWithOverride"><a href="#9-NativeLibraryHelper-copyNativeBinariesWithOverride" class="headerlink" title="9.NativeLibraryHelper#copyNativeBinariesWithOverride"></a>9.NativeLibraryHelper#copyNativeBinariesWithOverride</h3><p>在这个方法中，将不同的so库通过copyNativeBinariesForSupportedAbi方法copy到不同的目录。copy的具体流程就不说了。</p>
<p>到现在，copy的流程就完了。</p>
<p>在上面startCopy中，下面有handleReturnCode，是对copy后进行后续处理的，我们依然看，InstallParams的这个方法。</p>
<h3 id="10-InstallParams-handleReturnCode"><a href="#10-InstallParams-handleReturnCode" class="headerlink" title="10.InstallParams#handleReturnCode"></a>10.InstallParams#handleReturnCode</h3><p>在这个方法中，会调用processPendingInstall去处理。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div></pre></td><td class="code"><pre><div class="line">private void processPendingInstall(final InstallArgs args, final int currentStatus) &#123;</div><div class="line">    // Queue up an async operation since the package installation may take a little while.</div><div class="line">    mHandler.post(new Runnable() &#123;</div><div class="line">        public void run() &#123;</div><div class="line">            mHandler.removeCallbacks(this);</div><div class="line">             // Result object to be returned</div><div class="line">            PackageInstalledInfo res = new PackageInstalledInfo();</div><div class="line">            res.returnCode = currentStatus;</div><div class="line">            res.uid = -1;</div><div class="line">            res.pkg = null;</div><div class="line">            res.removedInfo = new PackageRemovedInfo();</div><div class="line">            if (res.returnCode == PackageManager.INSTALL_SUCCEEDED) &#123;</div><div class="line">                args.doPreInstall(res.returnCode);</div><div class="line">                synchronized (mInstallLock) &#123;</div><div class="line">                    installPackageLI(args, res);</div><div class="line">                &#125;</div><div class="line">                args.doPostInstall(res.returnCode, res.uid);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            // A restore should be performed at this point if (a) the install</div><div class="line">            // succeeded, (b) the operation is not an update, and (c) the new</div><div class="line">            // package has not opted out of backup participation.</div><div class="line">            final boolean update = res.removedInfo.removedPackage != null;</div><div class="line">            final int flags = (res.pkg == null) ? 0 : res.pkg.applicationInfo.flags;</div><div class="line">            boolean doRestore = !update</div><div class="line">                    &amp;&amp; ((flags &amp; ApplicationInfo.FLAG_ALLOW_BACKUP) != 0);</div><div class="line"></div><div class="line">            // Set up the post-install work request bookkeeping.  This will be used</div><div class="line">            // and cleaned up by the post-install event handling regardless of whether</div><div class="line">            // there&apos;s a restore pass performed.  Token values are &gt;= 1.</div><div class="line">            int token;</div><div class="line">            if (mNextInstallToken &lt; 0) mNextInstallToken = 1;</div><div class="line">            token = mNextInstallToken++;</div><div class="line"></div><div class="line">            PostInstallData data = new PostInstallData(args, res);</div><div class="line">            mRunningInstalls.put(token, data);</div><div class="line">            if (DEBUG_INSTALL) Log.v(TAG, &quot;+ starting restore round-trip &quot; + token);</div><div class="line"></div><div class="line">            if (res.returnCode == PackageManager.INSTALL_SUCCEEDED &amp;&amp; doRestore) &#123;</div><div class="line">                // Pass responsibility to the Backup Manager.  It will perform a</div><div class="line">                // restore if appropriate, then pass responsibility back to the</div><div class="line">                // Package Manager to run the post-install observer callbacks</div><div class="line">                // and broadcasts.</div><div class="line">                IBackupManager bm = IBackupManager.Stub.asInterface(</div><div class="line">                        ServiceManager.getService(Context.BACKUP_SERVICE));</div><div class="line">                if (bm != null) &#123;</div><div class="line">                    if (DEBUG_INSTALL) Log.v(TAG, &quot;token &quot; + token</div><div class="line">                            + &quot; to BM for possible restore&quot;);</div><div class="line">                    try &#123;</div><div class="line">                        if (bm.isBackupServiceActive(UserHandle.USER_OWNER)) &#123;</div><div class="line">                            bm.restoreAtInstall(res.pkg.applicationInfo.packageName, token);</div><div class="line">                        &#125; else &#123;</div><div class="line">                            doRestore = false;</div><div class="line">                        &#125;</div><div class="line">                    &#125; catch (RemoteException e) &#123;</div><div class="line">                        // can&apos;t happen; the backup manager is local</div><div class="line">                    &#125; catch (Exception e) &#123;</div><div class="line">                        Slog.e(TAG, &quot;Exception trying to enqueue restore&quot;, e);</div><div class="line">                        doRestore = false;</div><div class="line">                    &#125;</div><div class="line">                &#125; else &#123;</div><div class="line">                    Slog.e(TAG, &quot;Backup Manager not found!&quot;);</div><div class="line">                    doRestore = false;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            if (!doRestore) &#123;</div><div class="line">                // No restore possible, or the Backup Manager was mysteriously not</div><div class="line">                // available -- just fire the post-install work request directly.</div><div class="line">                if (DEBUG_INSTALL) Log.v(TAG, &quot;No restore - queue post-install for &quot; + token);</div><div class="line">                Message msg = mHandler.obtainMessage(POST_INSTALL, token, 0);</div><div class="line">                mHandler.sendMessage(msg);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>安装过程</p>
<ul>
<li>installPackageLI，在这个之前，会用doPreInstall进行cleanup操作，在这之后会用doPostInstall进行clean操作。</li>
<li>恢复部分代码 没看明白。😭</li>
<li>发送POST_INSTALL消息</li>
</ul>
<h3 id="11-installPackageLI"><a href="#11-installPackageLI" class="headerlink" title="11.installPackageLI"></a>11.installPackageLI</h3><p>改方法氛围几部分。</p>
<p>首先是解析包过程。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">PackageParser pp = new PackageParser();</div><div class="line">pp.setSeparateProcesses(mSeparateProcesses);</div><div class="line">pp.setDisplayMetrics(mMetrics);</div><div class="line"></div><div class="line">final PackageParser.Package pkg;</div><div class="line">try &#123;</div><div class="line">    pkg = pp.parsePackage(tmpPackageFile, parseFlags);</div><div class="line">&#125; catch (PackageParserException e) &#123;</div><div class="line">    res.setError(&quot;Failed parse during installPackageLI&quot;, e);</div><div class="line">    return;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>其次是校验签名的md5的过程</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">try &#123;</div><div class="line">    pp.collectCertificates(pkg, parseFlags);</div><div class="line">    pp.collectManifestDigest(pkg);</div><div class="line">&#125; catch (PackageParserException e) &#123;</div><div class="line">    res.setError(&quot;Failed collect during installPackageLI&quot;, e);</div><div class="line">    return;</div><div class="line">&#125;</div><div class="line"></div><div class="line">/* If the installer passed in a manifest digest, compare it now. */</div><div class="line">if (args.manifestDigest != null) &#123;</div><div class="line">    if (DEBUG_INSTALL) &#123;</div><div class="line">        final String parsedManifest = pkg.manifestDigest == null ? &quot;null&quot;</div><div class="line">                : pkg.manifestDigest.toString();</div><div class="line">        Slog.d(TAG, &quot;Comparing manifests: &quot; + args.manifestDigest.toString() + &quot; vs. &quot;</div><div class="line">                + parsedManifest);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    if (!args.manifestDigest.equals(pkg.manifestDigest)) &#123;</div><div class="line">        res.setError(INSTALL_FAILED_PACKAGE_CHANGED, &quot;Manifest digest changed&quot;);</div><div class="line">        return;</div><div class="line">    &#125;</div><div class="line">&#125; else if (DEBUG_INSTALL) &#123;</div><div class="line">    final String parsedManifest = pkg.manifestDigest == null</div><div class="line">            ? &quot;null&quot; : pkg.manifestDigest.toString();</div><div class="line">    Slog.d(TAG, &quot;manifestDigest was not present, but parser got: &quot; + parsedManifest);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>调用installNewPackageLI安装。</p>
<h3 id="12-installNewPackageLI"><a href="#12-installNewPackageLI" class="headerlink" title="12.installNewPackageLI"></a>12.installNewPackageLI</h3><p>在这个方法中，调用scanPackageDirtyLI进行扫描，而在scanPackageDirtyLI中，经过复杂的操作之后就算完成了安装，诸如，创建用户数据目录，进行dex优化等等。</p>
<h3 id="13-处理POST-INSTALL消息"><a href="#13-处理POST-INSTALL消息" class="headerlink" title="13.处理POST_INSTALL消息"></a>13.处理POST_INSTALL消息</h3><p>略。</p>
<hr>
<h3 id="最近访客"><a href="#最近访客" class="headerlink" title="最近访客"></a>最近访客</h3><ul class="ds-recent-visitors" data-num-items="46" data-avatar-size="40"></ul>








</the>
      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>


    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/framework/" rel="tag"># framework</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/01/02/android应用进程是如何启动的/" rel="next" title="android应用进程是如何启动的">
                <i class="fa fa-chevron-left"></i> android应用进程是如何启动的
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2017/01/05/AMS中的进程管理部分－上/" rel="prev" title="AMS中的进程管理部分－上">
                AMS中的进程管理部分－上 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>

          
          </div>
          


          
  <div class="comments" id="comments">
    
      <div class="ds-thread" data-thread-key="2017/01/04/Android应用程序是如何安装的/"
           data-title="Android应用程序是如何安装的" data-url="http://guolei1130.github.io/2017/01/04/Android应用程序是如何安装的/">
      </div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/img/head.png"
               alt="_StriveG" />
          <p class="site-author-name" itemprop="name">_StriveG</p>
          <p class="site-description motion-element" itemprop="description">稳住，我们能行！</p>
        </div>
        <nav class="site-state motion-element">
        
          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">57</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">6</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">20</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://guolei1130.github.io/" target="_blank" title="博客首页">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  博客首页
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://github.com/Guolei1130/" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://blog.csdn.net/qq_21430549" target="_blank" title="csdn博客">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  csdn博客
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://monsterlin.com/" target="_blank" title="友情链接">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  友情链接
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-前言"><span class="nav-number">1.</span> <span class="nav-text">1.前言</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-安装器"><span class="nav-number">2.</span> <span class="nav-text">2.安装器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-ApplicationPackageManager-installPackageWithVerificationAndEncryption"><span class="nav-number">3.</span> <span class="nav-text">3.ApplicationPackageManager#installPackageWithVerificationAndEncryption</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-PackageManagerService-installPackage"><span class="nav-number">4.</span> <span class="nav-text">4.PackageManagerService#installPackage</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-HandlerParams-startCopy"><span class="nav-number">5.</span> <span class="nav-text">5.HandlerParams#startCopy</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-InstallParams-handleStartCopy"><span class="nav-number">6.</span> <span class="nav-text">6.InstallParams#handleStartCopy</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-InstallArgs-copyApk"><span class="nav-number">7.</span> <span class="nav-text">7.InstallArgs#copyApk</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-DefaultContainerService-copyPackage"><span class="nav-number">8.</span> <span class="nav-text">8.DefaultContainerService#copyPackage</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-NativeLibraryHelper-copyNativeBinariesWithOverride"><span class="nav-number">9.</span> <span class="nav-text">9.NativeLibraryHelper#copyNativeBinariesWithOverride</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#10-InstallParams-handleReturnCode"><span class="nav-number">10.</span> <span class="nav-text">10.InstallParams#handleReturnCode</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#11-installPackageLI"><span class="nav-number">11.</span> <span class="nav-text">11.installPackageLI</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#12-installNewPackageLI"><span class="nav-number">12.</span> <span class="nav-text">12.installNewPackageLI</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#13-处理POST-INSTALL消息"><span class="nav-number">13.</span> <span class="nav-text">13.处理POST_INSTALL消息</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#最近访客"><span class="nav-number">14.</span> <span class="nav-text">最近访客</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2016 - 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">_StriveG</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>


        

<div class="busuanzi-count">

  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv"><i class="fa fa-user"></i><span class="busuanzi-value" id="busuanzi_value_site_uv"></span></span>
  

  
    <span class="site-pv"><i class="fa fa-eye"></i><span class="busuanzi-value" id="busuanzi_value_site_pv"></span></span>
  
  
</div>



        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  




  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.0"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"guolei1130"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  












  
  

  

  

  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  


</body>
</html>
